// Variables globales
let currentUser = null;
let products = [];
let selectedImage = null;

// Ã‰lÃ©ments DOM
const els = {
  authModal: document.getElementById('authModal'),
  subscriptionModal: document.getElementById('subscriptionModal'),
  addProductModal: document.getElementById('addProductModal'),
  productDetailModal: document.getElementById('productDetailModal'),
  loginBtn: document.getElementById('loginBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  addProductBtn: document.getElementById('addProductBtn'),
  addFirstProductBtn: document.getElementById('addFirstProductBtn'),
  subscribeBtn: document.getElementById('subscribeBtn'),
  userInfo: document.getElementById('userInfo'),
  userName: document.getElementById('userName'),
  userAvatar: document.getElementById('userAvatar'),
  subBadge: document.getElementById('subBadge'),
  productsGrid: document.getElementById('productsGrid'),
  emptyState: document.getElementById('emptyState'),
  productCount: document.getElementById('productCount'),
  productLimit: document.getElementById('productLimit'),
  uploadBtn: document.getElementById('uploadBtn'),
  productImage: document.getElementById('productImage'),
  imagePreview: document.getElementById('imagePreview'),
  uploadText: document.getElementById('uploadText')
};

// Fonctions utilitaires
function showModal(modal) {
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideModal(modal) {
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function formatPrice(v) {
  return new Intl.NumberFormat('fr-FR').format(v);
}

function getCategoryLabel(c) {
  return {
    electronics: 'Ã‰lectronique',
    fashion: 'Mode',
    home: 'Maison'
  }[c] || c;
}

function notify(msg) {
  const n = document.createElement('div');
  n.style.cssText = 'position:fixed;top:20px;right:20px;background:#1a1a1a;color:white;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:2000;animation:slideIn 0.3s ease;';
  n.textContent = msg;
  document.body.appendChild(n);
  setTimeout(() => {
    n.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => n.remove(), 300);
  }, 3000);
}

// Mise Ã  jour de l'interface
function updateUI() {
  if (currentUser) {
    els.loginBtn.classList.add('hidden');
    els.logoutBtn.classList.remove('hidden');
    els.userInfo.classList.remove('hidden');
    els.addProductBtn.classList.remove('hidden');
    els.subscribeBtn.classList.remove('hidden');
    els.userName.textContent = currentUser.name.split(' ')[0];
    els.userAvatar.textContent = currentUser.name[0].toUpperCase();
    
    if (currentUser.subscribed) {
      els.subBadge.classList.remove('hidden');
      els.productLimit.textContent = 'âˆž';
    } else {
      els.subBadge.classList.add('hidden');
      els.productLimit.textContent = '5';
    }
  } else {
    els.loginBtn.classList.remove('hidden');
    els.logoutBtn.classList.add('hidden');
    els.userInfo.classList.add('hidden');
    els.addProductBtn.classList.add('hidden');
    els.subscribeBtn.classList.add('hidden');
  }
  renderProducts();
}

// Gestion des onglets d'authentification
document.querySelectorAll('.auth-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
    tab.classList.add('active');
    const formId = tab.dataset.tab === 'signin' ? 'signinForm' : 'signupForm';
    document.getElementById(formId).classList.remove('hidden');
  });
});

// Liens de basculement entre formulaires
document.getElementById('switchToSignup').addEventListener('click', e => {
  e.preventDefault();
  document.querySelector('[data-tab="signup"]').click();
});

document.getElementById('switchToSignin').addEventListener('click', e => {
  e.preventDefault();
  document.querySelector('[data-tab="signin"]').click();
});

// Connexion
document.getElementById('signinForm').addEventListener('submit', e => {
  e.preventDefault();
  const email = document.getElementById('signinEmail').value;
  const password = document.getElementById('signinPassword').value;
  const users = JSON.parse(localStorage.getItem('resell_users') || '[]');
  const user = users.find(u => u.email === email && u.password === password);
  
  if (user) {
    currentUser = user;
    localStorage.setItem('resell_current_user', JSON.stringify(user));
    hideModal(els.authModal);
    notify('Connexion rÃ©ussie !');
    updateUI();
  } else {
    alert('Email ou mot de passe incorrect');
  }
});

// Inscription
document.getElementById('signupForm').addEventListener('submit', e => {
  e.preventDefault();
  const name = document.getElementById('signupName').value;
  const email = document.getElementById('signupEmail').value;
  const phone = document.getElementById('signupPhone').value;
  const password = document.getElementById('signupPassword').value;
  const users = JSON.parse(localStorage.getItem('resell_users') || '[]');
  
  if (users.find(u => u.email === email)) {
    alert('Cet email est dÃ©jÃ  utilisÃ©');
    return;
  }
  
  const user = {
    id: Date.now(),
    name,
    email,
    phone,
    password,
    subscribed: false,
    createdAt: new Date().toISOString()
  };
  
  users.push(user);
  localStorage.setItem('resell_users', JSON.stringify(users));
  currentUser = user;
  localStorage.setItem('resell_current_user', JSON.stringify(user));
  hideModal(els.authModal);
  notify('Compte crÃ©Ã© avec succÃ¨s !');
  updateUI();
});

// DÃ©connexion
els.logoutBtn.addEventListener('click', () => {
  if (confirm('Voulez-vous vraiment vous dÃ©connecter ?')) {
    currentUser = null;
    localStorage.removeItem('resell_current_user');
    notify('DÃ©connexion rÃ©ussie');
    updateUI();
  }
});

// Paiement d'abonnement
document.getElementById('paymentForm').addEventListener('submit', e => {
  e.preventDefault();
  const method = document.getElementById('paymentMethod').value;
  const phone = document.getElementById('paymentPhone').value;
  
  if (!method || !phone) {
    alert('Veuillez remplir tous les champs');
    return;
  }
  
  // Simulation de paiement
  notify('Traitement du paiement...');
  setTimeout(() => {
    currentUser.subscribed = true;
    currentUser.subscriptionDate = new Date().toISOString();
    
    // Mettre Ã  jour dans localStorage
    const users = JSON.parse(localStorage.getItem('resell_users') || '[]');
    const index = users.findIndex(u => u.id === currentUser.id);
    if (index !== -1) {
      users[index] = currentUser;
      localStorage.setItem('resell_users', JSON.stringify(users));
    }
    localStorage.setItem('resell_current_user', JSON.stringify(currentUser));
    
    hideModal(els.subscriptionModal);
    notify('ðŸŽ‰ Abonnement Premium activÃ© !');
    updateUI();
  }, 2000);
});

// Upload d'image
els.uploadBtn.addEventListener('click', () => els.productImage.click());

els.productImage.addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    if (file.size > 5 * 1024 * 1024) {
      alert("L'image est trop grande. Maximum 5MB.");
      return;
    }
    const reader = new FileReader();
    reader.onload = event => {
      selectedImage = event.target.result;
      els.imagePreview.innerHTML = `<img src="${selectedImage}" alt="Preview">`;
      els.imagePreview.classList.remove('hidden');
      els.uploadText.textContent = "Changer l'image";
    };
    reader.readAsDataURL(file);
  }
});

// Ajouter un produit
function openAddProductModal() {
  if (!currentUser) {
    showModal(els.authModal);
    notify('Veuillez vous connecter pour ajouter un produit');
    return;
  }
  
  const userProducts = products.filter(p => p.userId === currentUser.id);
  if (!currentUser.subscribed && userProducts.length >= 5) {
    alert('Limite atteinte ! Abonnez-vous pour ajouter plus de 5 produits.');
    showModal(els.subscriptionModal);
    return;
  }
  
  showModal(els.addProductModal);
}

els.addProductBtn.addEventListener('click', openAddProductModal);
els.addFirstProductBtn.addEventListener('click', openAddProductModal);

document.getElementById('cancelBtn').addEventListener('click', () => {
  hideModal(els.addProductModal);
  resetProductForm();
});

document.getElementById('closeModalBtn').addEventListener('click', () => {
  hideModal(els.addProductModal);
  resetProductForm();
});

function resetProductForm() {
  document.getElementById('productForm').reset();
  selectedImage = null;
  els.imagePreview.classList.add('hidden');
  els.imagePreview.innerHTML = '';
  els.uploadText.textContent = 'TÃ©lÃ©charger une image';
}

document.getElementById('submitProductBtn').addEventListener('click', () => {
  const name = document.getElementById('productName').value.trim();
  const description = document.getElementById('productDesc').value.trim();
  const price = parseInt(document.getElementById('productPrice').value);
  const phone = document.getElementById('productPhone').value.trim();
  const city = document.getElementById('productCity').value.trim();
  const category = document.getElementById('productCategory').value;
  
  if (!name || !description || !price || !phone || !city) {
    alert('Veuillez remplir tous les champs obligatoires');
    return;
  }
  
  if (price <= 0) {
    alert('Le prix doit Ãªtre supÃ©rieur Ã  0');
    return;
  }
  
  const product = {
    id: Date.now(),
    userId: currentUser.id,
    name,
    description,
    price,
    phone,
    city,
    category,
    image: selectedImage,
    createdAt: new Date().toISOString()
  };
  
  products.push(product);
  saveProducts();
  hideModal(els.addProductModal);
  resetProductForm();
  notify('Produit ajoutÃ© avec succÃ¨s !');
  renderProducts();
});

// Afficher les produits
function renderProducts() {
  const userProducts = currentUser ? products.filter(p => p.userId === currentUser.id) : [];
  els.productCount.textContent = userProducts.length;
  
  if (products.length === 0) {
    els.emptyState.classList.remove('hidden');
    els.productsGrid.classList.add('hidden');
  } else {
    els.emptyState.classList.add('hidden');
    els.productsGrid.classList.remove('hidden');
    els.productsGrid.innerHTML = '';
    
    products.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-image">${p.image ? `<img src="${p.image}" alt="${p.name}">` : 'ðŸ“¦ Image produit'}</div>
        <div class="product-info">
          <div class="product-badge">${getCategoryLabel(p.category)}</div>
          <h3>${p.name}</h3>
          <p>${p.description.length > 80 ? p.description.substring(0, 80) + '...' : p.description}</p>
          <div class="product-price">${formatPrice(p.price)} FCFA</div>
          <button class="btn btn-primary" style="width:100%;">Voir les dÃ©tails</button>
        </div>
      `;
      
      card.querySelector('.btn-primary').addEventListener('click', () => {
        openProductDetail(p);
      });
      
      els.productsGrid.appendChild(card);
    });
  }
}

// DÃ©tails du produit
function openProductDetail(product) {
  document.getElementById('detailBody').innerHTML = `
    <div class="detail-image">${product.image ? `<img src="${product.image}" alt="${product.name}">` : 'ðŸ“¦ Image produit'}</div>
    <div class="detail-section">
      <div class="product-badge">${getCategoryLabel(product.category)}</div>
      <h3>${product.name}</h3>
      <div class="detail-price">${formatPrice(product.price)} FCFA</div>
    </div>
    <div class="detail-section">
      <h3>Description</h3>
      <p>${product.description}</p>
    </div>
    <div class="detail-section">
      <h3>Informations du vendeur</h3>
      <div class="detail-info-grid">
        <div class="detail-info-item"><strong>TÃ©lÃ©phone</strong><span>${product.phone}</span></div>
        <div class="detail-info-item"><strong>Ville</strong><span>${product.city}</span></div>
      </div>
    </div>
  `;
  
  document.getElementById('contactSellerBtn').onclick = () => {
    const msg = encodeURIComponent(`Bonjour, je suis intÃ©ressÃ© par votre produit: ${product.name}`);
    const whatsappUrl = `https://wa.me/${product.phone.replace(/\s+/g, '')}?text=${msg}`;
    window.open(whatsappUrl, '_blank');
  };
  
  showModal(els.productDetailModal);
}

document.getElementById('closeDetailBtn').addEventListener('click', () => {
  hideModal(els.productDetailModal);
});

document.getElementById('closeDetailFooterBtn').addEventListener('click', () => {
  hideModal(els.productDetailModal);
});

// Fermer les modals en cliquant sur le fond
[els.authModal, els.subscriptionModal, els.addProductModal, els.productDetailModal].forEach(modal => {
  modal.addEventListener('click', e => {
    if (e.target === modal) {
      hideModal(modal);
    }
  });
});

// Boutons de modal
els.loginBtn.addEventListener('click', () => showModal(els.authModal));
document.getElementById('closeAuthBtn').addEventListener('click', () => hideModal(els.authModal));
els.subscribeBtn.addEventListener('click', () => showModal(els.subscriptionModal));
document.getElementById('closeSubBtn').addEventListener('click', () => hideModal(els.subscriptionModal));

// Sauvegarder/Charger les donnÃ©es
function saveProducts() {
  localStorage.setItem('resell_products', JSON.stringify(products));
}

function loadProducts() {
  const saved = localStorage.getItem('resell_products');
  if (saved) {
    products = JSON.parse(saved);
  }
}

function loadCurrentUser() {
  const saved = localStorage.getItem('resell_current_user');
  if (saved) {
    currentUser = JSON.parse(saved);
  }
}

// Initialisation
loadCurrentUser();
loadProducts();
updateUI();

console.log('âœ… Resell Platform chargÃ©e avec succÃ¨s !');
